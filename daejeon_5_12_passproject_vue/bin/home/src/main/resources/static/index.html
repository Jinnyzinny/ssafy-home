<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite App</title>
  <script
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d02b03ce9a797eb1398d15acce7bfb49&libraries=services"></script>
  <script type="module" crossorigin src="/assets/index-DU9YlFwV.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-BnQjedei.css">
</head>

		<div class="tab-content" id="myTabContent">
			<!-- Tab 1: 지역 선택 -->
			<div class="tab-pane fade show active" id="select" role="tabpanel" aria-labelledby="select-tab">
				<h4>지역 선택</h4>
				<form id="selection-form" method="post">
					<div class="form-group">
						<label for="sido-select">시도 선택</label>
						<select class="form-control" id="sido-select" name="province"></select>
					</div>
					<div class="form-group">
						<label for="gugun-select">구군 선택</label>
						<select class="form-control" id="gugun-select" name="city">
							<option value="">구군선택</option>
						</select>
					</div>
					<div class="form-group">
						<label for="dong-select">동 선택</label>
						<select class="form-control" id="dong-select" name="dong">
							<option value="">동선택</option>
						</select>
					</div>
					<div class="form-group">
						<label for="year-select">연도 선택</label>
						<select class="form-control" id="year-select" name="year">
							<option value="">연도선택</option>
						</select>
					</div>
					<div class="form-group">
						<label for="month-select">월 선택</label>
						<select class="form-control" id="month-select" name="month">
							<option value="">월선택</option>
						</select>
					</div>
					<input type="hidden" id="latitude" name="latitude" />
					<input type="hidden" id="longitude" name="longitude" />
					<div class="mb-4 text-right">
						<button type="button" class="btn btn-primary" id="selection-search-btn" onclick="searchAptDeals()">검색</button>
						<button type="button" class="btn btn-primary" id="areaAddBtn" onclick="addFavoriteArea()">관심 지역으로 추가</button>
					</div>
				</form>
			</div>

			<!-- Tab 2: 관심 지역 -->
			<div class="tab-pane fade" id="search" role="tabpanel" aria-labelledby="search-tab">
				<h4>관심 지역</h4>
				<div class="container my-5">
					<table class="table table-bordered">
						<tbody id="fav-list">
						</tbody>
					</table>
					<button class="btn btn-primary" onclick="fetchInterestInfo()">관심 지역 정보 조회</button>
				</div>
			</div>

			<!-- Tab 3: 대기 정보 -->
			<div class="tab-pane fade" id="dustinfo" role="tabpanel" aria-labelledby="dustinfo-tab">
				<h4>대기 정보</h4>
				<div class="container my-5">
					<table class="table table-hover text-center">
						<tr>
							<th>번호</th>
							<th>군/구</th>
							<th>등급</th>
						</tr>
						<tbody id="dustinfolist"></tbody>
					</table>
					<button class="btn btn-primary" onclick="fetchDustInfo()">대기 정보 조회</button>
				</div>
			</div>
		</div>
	</div>

	<div id="top-right-buttons">
    	<button class="btn btn-custom info-btn" id="info-btn" onclick="location.href='/board'">게시판</button>
    	<div id="auth-buttons">
        	<!-- JavaScript에서 인증 상태에 따라 버튼을 동적으로 추가 -->
    	</div>
	</div>

	<!-- External Libraries -->
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

	<!-- Kakao Map API -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=05a47079bf95d0a15cefbb1c9fc58b82&libraries=services"></script>

	<!-- Local JavaScript files -->
	<script src="/js/map.js"></script>
	<script src="/js/user.js"></script>

	<script>
document.addEventListener("DOMContentLoaded", function() {
    const authButtons = document.getElementById("auth-buttons");
    const token = localStorage.getItem("token");

    // JWT 토큰이 있으면 인증 상태 확인
    if (token) {
    	console.log("JWT 토큰이 있습니다.");
        fetch("/user/status", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.authenticated) {
                console.log("로그인된 상태입니다.");
                authButtons.innerHTML = `
                	<button class="btn btn-custom" id="profile-btn" onclick="location.href='/user/edit.html'">회원정보</button>
                    <button class="btn btn-custom" id="logout-btn" onclick="logout()">로그아웃</button>
                `;
            } else {
                console.log("로그인되지 않은 상태입니다.");
                showLoginButtons(authButtons); // 비로그인 상태 처리
            }
        })
        .catch(error => {
            console.error("사용자 상태 조회 오류:", error);
            showLoginButtons(authButtons); // 오류 시에도 비로그인 상태로 간주
        });
    } else {
        console.log("JWT 토큰이 존재하지 않습니다.");
        showLoginButtons(authButtons); // 토큰이 없으면 비로그인 상태로 간주
    }
});

function showLoginButtons(authButtons) {
    authButtons.innerHTML = `
        <button class="btn btn-custom" id="login-btn" onclick="openLoginPage()">로그인</button>
        <button class="btn btn-custom" id="signup-btn" onclick="location.href='/user/join.html'">회원가입</button>
    `;
}

function openLoginPage() {
    window.location.href = "/user/login.html";
}

function logout() {
    // 로컬 스토리지에서 토큰 제거
    localStorage.removeItem("token");
    location.reload(); // 로그아웃 후 페이지 새로고침
}

function login() {
    const userId = document.getElementById("userid").value;
    const userPwd = document.getElementById("userpwd").value;

    if (!userId || !userPwd) {
        alert("아이디와 비밀번호를 입력하세요!");
        return;
    }

    fetch("/user/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, userPwd })
    })
    .then(response => response.json())
    .then(data => {
        if (data.token) {
            // 로그인 성공 시 JWT 토큰을 로컬 스토리지에 저장
            localStorage.setItem("jwtToken", data.token);
            location.reload(); // 로그인 후 페이지 새로고침
        } else {
            alert("로그인 실패: " + (data.message || "알 수 없는 오류"));
        }
    })
    .catch(error => console.error("로그인 오류:", error));
}

</script>

</body>

</html>